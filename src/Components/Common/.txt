import React, { useEffect, useState } from "react";
import {
    Table,
    TableBody,
    TableCell,
    TableContainer,
    TableHead,
    TableRow,
    Paper,
    TableFooter,
    Button,
    tableCellClasses,
} from "@mui/material";
import { styled } from "@mui/system";
import { useDispatch } from "react-redux";
import { updateCycleGamesApi } from "../../redux/action/adminAction";

// Custom styled TableCell for headers and body cells
const StyledTableCell = styled(TableCell)(({ theme }) => ({
    [&.${tableCellClasses?.head}]: {
        backgroundColor: "#1976d2",
        color: "#fff",
        fontWeight: "bold",
        textAlign: "center",
    },
    [&.${tableCellClasses?.body}]: {
        fontSize: 14,
        textAlign: "center",
    },
    [&.${tableCellClasses?.footer}]: {
        backgroundColor: "#1976d2",
        color: "#fff",
        fontWeight: "bold",
        textAlign: "center",
    },
}));

const StyledTableRow = styled(TableRow)(({ theme }) => ({
    "&:nth-of-type(odd)": {
        backgroundColor: "rgb(0 0 0 / 4%)",
    },
    "&:last-child td, &:last-child th": {
        border: 0,
    },
}));

const CycleTimeGamesTable = ({ data, cc }) => {
    const dispatch = useDispatch();
    const [assessmentData, setAssessmentData] = useState([]);
    console.log(data, "test")

    useEffect(() => {
        if (data && data.length > 0) {
            const transformedData = data.map((exercise) => {
                // Group all attempts for this specific task
                const taskAttempts = data.filter(item =>
                    String(item.task_id) === String(exercise.task_id)
                ).sort((a, b) => a.attempt_number - b.attempt_number);

                // Create attempts array with 5 slots, fully populating from existing attempts
                const attemptsArray = Array.from({ length: 5 }, (_, index) => {
                    const matchingAttempt = taskAttempts[index];

                    return matchingAttempt ? {
                        attempts_id: matchingAttempt.attempts_id || null,
                        pf_status: matchingAttempt.pf_status || "",
                        mistakes: matchingAttempt.mistakes || "",
                        cycle_time: matchingAttempt.cycle_time || "",
                    } : {
                        attempts_id: null,
                        pf_status: "",
                        mistakes: "",
                        cycle_time: "",
                    };
                });

                return {
                    ...exercise,
                    attempts: attemptsArray,
                    status_: exercise.status_ || "",
                    signByTrainee: exercise.Signature_by_Trainee || "",
                    signByProcessCoach: exercise.Signature_by_Process_Coach || "",
                    signByTrainingOfficer: exercise.Signature_by_Training_Officer || "",
                };
            });

            console.log("Transformed Data:", transformedData);
            setAssessmentData(transformedData);
        }
    }, [data]);

    const handleValueChange = (exerciseIndex, field, attemptIndex, value) => {
        setAssessmentData((prevData) => {
            const updatedData = [...prevData];
            if (attemptIndex !== null) {
                updatedData[exerciseIndex].attempts[attemptIndex] = {
                    ...updatedData[exerciseIndex].attempts[attemptIndex],
                    [field]: value,
                };
            } else {
                updatedData[exerciseIndex][field] = value;
            }
            return updatedData;
        });
    };

    const handleSave = () => {
        const payload = {
            Cycle_games: assessmentData.map((exercise) => ({
                task_id: exercise.task_id,
                attempts: exercise.attempts.map((attempt, index) => ({
                    attempt_number: index + 1,
                    ...attempt,
                })),
                status_: exercise.status_,
                sign: {
                    Signature_by_Trainee: exercise.signByTrainee,
                    Signature_by_Process_Coach: exercise.signByProcessCoach,
                    Signature_by_Training_Officer: exercise.signByTrainingOfficer,
                },
            })),
            cc_no: cc,
        };
        console.log(payload, "Payload for API");
        dispatch(updateCycleGamesApi(payload));
    };

    return (
        <TableContainer component={Paper} sx={{ mt: 2, mb: 2 }}>
            <Table stickyHeader>
                <TableHead>
                    <TableRow>
                        <StyledTableCell rowSpan={2}>Exercise Name</StyledTableCell>
                        <StyledTableCell rowSpan={2}>Default Cycle Time</StyledTableCell>
                        <StyledTableCell colSpan={5}>Skill Assessment (Attempts)</StyledTableCell>
                        <StyledTableCell rowSpan={2}>Status</StyledTableCell>
                    </TableRow>
                    <TableRow>
                        {[1, 2, 3, 4, 5].map((attempt) => (
                            <StyledTableCell key={attempt}>{Attempt ${attempt}}</StyledTableCell>
                        ))}
                    </TableRow>
                </TableHead>
                <TableBody>
                    {assessmentData.map((exercise, index) => (
                        <StyledTableRow key={index}>
                            <StyledTableCell>{exercise?.name}</StyledTableCell>
                            <StyledTableCell>{exercise.dct || "-"}</StyledTableCell>
                            {exercise.attempts.map((attempt, attemptIndex) => (
                                <StyledTableCell key={attemptIndex}>
                                    <div>
                                        <input
                                            type="text"
                                            placeholder="PF"
                                            value={attempt.pf_status}
                                            onChange={(e) =>
                                                handleValueChange(index, "pf_status", attemptIndex, e.target.value)
                                            }
                                        />
                                        <input
                                            type="number"
                                            placeholder="Mistakes"
                                            value={attempt.mistakes}
                                            onChange={(e) =>
                                                handleValueChange(index, "mistakes", attemptIndex, e.target.value)
                                            }
                                        />
                                        <input
                                            type="text"
                                            placeholder="Cycle Time"
                                            value={attempt.cycle_time}
                                            onChange={(e) =>
                                                handleValueChange(index, "cycle_time", attemptIndex, e.target.value)
                                            }
                                        />
                                    </div>
                                </StyledTableCell>
                            ))}
                            <StyledTableCell>
                                <input
                                    type="text"
                                    value={exercise.status_}
                                    onChange={(e) =>
                                        handleValueChange(index, "status_", null, e.target.value)
                                    }
                                />
                            </StyledTableCell>
                        </StyledTableRow>
                    ))}
                </TableBody>
                <TableFooter>
                    <TableRow>
                        <StyledTableCell colSpan={4}>
                            <Button variant="contained" onClick={handleSave}>
                                Save
                            </Button>
                        </StyledTableCell>
                    </TableRow>
                </TableFooter>
            </Table>
        </TableContainer>
    );
};

export default CycleTimeGamesTable;